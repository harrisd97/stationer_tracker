<!DOCTYPE html>
<html lang="en">
<head>
  <!-- H-1: Meta and Title -->
  <!-- H-1.1: Meta tags for character encoding and responsiveness -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Expenses & Profit Tracker</title>

  <!-- H-2: External CSS & Fonts -->
  <!-- H-2.1: Bootstrap, Google Fonts, FontAwesome -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Poppins:wght@300;500;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <!-- H-3: Custom CSS Styles -->
  <!-- H-3.1: All style numbering uses S- prefix, see below -->
  <style>
    /* S-1: Root Variables */
    :root {
      /* S-1.1: Color palette and gradients for consistent styling */
      --primary-color: #f8f6fa;
      --accent-color: #b399cc;
      --text-color: #4a4158;
      --border-color: #e2daea;
      --shadow-color: rgba(179, 153, 204, 0.15);
      --gradient-start: #ffffff;
      --gradient-end: #f8f6fa;
      --title-color: #7a4e82;
      --title-shadow: rgba(122, 78, 130, 0.1);
    }

    /* S-2: CSS Reset */
    * {
      /* S-2.1: Reset margins, paddings, and box-sizing for consistency */
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    /* S-3: HTML & Body */
    html, body {
      /* S-3.1: Full height and width, prevent overflow */
      height: 100%;
      width: 100%;
      overflow-x: hidden;
    }

    body {
      /* S-3.2: Body styling: Flex layout, background, font, color */
      display: flex;
      flex-direction: column; /* Stack header, main, footer vertically */
      min-height: 100vh; /* Full viewport height */
      font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: url('https://www.transparenttextures.com/patterns/white-diamond.png'), 
                  linear-gradient(to bottom, var(--gradient-start), var(--gradient-end));
      color: var(--text-color);
      position: relative;
    }

    /* S-4: Decorative Pseudo-elements */
    body::before, body::after {
      /* S-4.1: Decorative pseudo-elements to add visual flair */
      content: "";
      position: fixed;
      z-index: -1;
      width: 250px;
      height: 250px;
      background-size: contain;
      background-repeat: no-repeat;
      opacity: 0.3;
    }
    /* S-4.2: End of decorative elements */

    /* S-5: Navbar */
    .navbar {
      /* S-5.1: Navbar styling: semi-transparent background, border, shadow */
      background-color: rgba(255, 255, 255, 0.95);
      border-bottom: 1px solid var(--border-color);
      box-shadow: 0 2px 10px var(--shadow-color);
      position: sticky;
      top: 0;
      z-index: 1050;
    }

    .navbar-brand {
      /* S-5.2: Brand styling: custom font, size, color, hover effect */
      font-family: 'Great Vibes', cursive;
      font-size: 2rem;
      color: var(--title-color) !important;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      animation: fadeInUp 0.8s ease-out;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent; /* Remove tap highlight on mobile */
    }

    .navbar-subtitle {
      /* S-5.3: Navbar subtitle styling */
      font-family: 'Great Vibes', cursive;
      font-size: 1.5rem;
      color: var(--title-color);
      margin-left: 1.5rem;
      opacity: 0.9;
      animation: fadeIn 0.8s ease-out;
    }

    .navbar-brand:hover {
      /* S-5.4: Navbar brand hover effect */
      transform: translateY(-2px);
      text-shadow: 0 4px 8px var(--shadow-color);
    }

    .navbar-brand i {
      /* S-5.5: Navbar brand icon styling */
      font-size: 2rem;
      color: var(--title-color);
      transition: all 0.3s ease;
    }

    .navbar-brand:hover i {
      /* S-5.6: Navbar brand icon hover effect */
      transform: rotate(-15deg);
    }

    @media (max-width: 768px) {
      /* S-5.7: Navbar responsive adjustments for subtitle and brand */
      .navbar-subtitle {
        font-size: 1rem;
        margin-left: 0.75rem;
        display: block;
      }
      .navbar-brand {
        flex-wrap: wrap;
        justify-content: center;
        text-align: center;
      }
    }

    .nav-link {
      /* S-5.8: Navigation links styling */
      color: var(--title-color) !important;
      font-weight: 500;
      transition: color 0.2s ease;
    }

    .nav-link:hover {
      /* S-5.9: Hover effect for nav links */
      color: var(--accent-color) !important;
    }

    .nav-item {
      /* S-5.10: Spacing between nav items */
      margin: 0 0.5rem;
    }

    /* S-6: Main Container */
    .main-container {
      /* S-6.1: Main container styling: centered, padded, with background & shadow */
      flex: 1 0 auto; /* Expand to fill available space */
      width: calc(100% - 2rem);
      max-width: 1200px;
      margin: 1rem auto;
      padding: 1.5rem;
      background-color: rgba(255, 255, 255, 0.98);
      border-radius: 1rem;
      box-shadow: 0 4px 20px var(--shadow-color);
      animation: fadeInUp 0.8s ease-out; /* Animate on load */
    }

    /* S-7: KPI Summary Cards */
    .summary-cards {
      /* S-7.1: KPI Summary Cards layout: grid for responsiveness */
      display: grid;
      grid-template-columns: repeat(2, 1fr); /* 2 columns by default */
      gap: 1rem;
      margin-bottom: 2rem;
      opacity: 0;
      animation: fadeIn 0.8s ease-out forwards;
      animation-delay: 0.3s;
    }

    .summary-card {
      /* S-7.2: Individual KPI card style */
      background: linear-gradient(135deg, #f5f0ff, #e9d4f5);
      border: 1px solid var(--border-color);
      border-radius: 1rem;
      padding: 1.2rem;
      text-align: center;
      box-shadow: 0 4px 15px var(--shadow-color);
      transition: transform 0.2s ease;
    }

    .summary-card:hover {
      /* S-7.3: Hover effect for KPI cards */
      transform: translateY(-2px);
    }

    .summary-card h6 {
      /* S-7.4: Card titles style */
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--accent-color);
      text-transform: uppercase;
      margin-bottom: 0.5rem;
    }

    .summary-card p {
      /* S-7.5: KPI values style */
      font-size: 1.4rem;
      font-weight: bold;
      color: var(--text-color);
      margin: 0;
    }

    /* S-8: Table Styling */
    .table {
      /* S-8.1: Table styling for expense list */
      background-color: white;
      border-radius: 0.75rem;
      overflow: hidden;
    }
    thead {
      /* S-8.2: Table header background */
      background-color: var(--primary-color);
    }
    tbody tr:hover {
      /* S-8.3: Table row hover effect */
      background-color: rgba(179, 153, 204, 0.05);
    }

    /* S-9: Form Controls */
    .form-control, .form-select {
      /* S-9.1: Form controls styling: border, focus effects */
      border-color: var(--border-color);
      border-radius: 0.5rem;
    }
    .form-control:focus, .form-select:focus {
      border-color: var(--accent-color);
      box-shadow: 0 0 0 0.2rem rgba(179, 153, 204, 0.25);
    }

    /* S-10: Buttons */
    .btn-primary {
      /* S-10.1: Primary button styling */
      background-color: var(--accent-color);
      border: none;
    }
    .btn-primary:hover {
      /* S-10.2: Primary button hover */
      background-color: #9f84b8;
    }
    .btn-outline-secondary {
      /* S-10.3: Outline secondary button styling */
      border-color: var(--accent-color);
      color: var(--accent-color);
    }

    /* S-11: Footer */
    .footer {
      /* S-11.1: Footer styling */
      flex-shrink: 0;
      padding: 1rem;
      background: linear-gradient(to right, var(--gradient-start), var(--gradient-end));
      color: var(--title-color);
      border-top: 1px solid var(--border-color);
      text-align: center;
    }

    /* S-12: Responsive Adjustments */
    @media (min-width: 768px) {
      /* S-12.1: Summary cards grid for larger screens */
      .summary-cards {
        grid-template-columns: repeat(4, 1fr); /* 4 columns on larger screens */
      }
      .main-container {
        margin: 2rem auto;
        padding: 2rem;
      }
    }
    @media (max-width: 767px) {
      /* S-12.2: Summary cards grid for smaller screens */
      .summary-cards {
        grid-template-columns: repeat(2, 1fr); /* 2 columns on smaller screens */
      }
      .summary-card {
        padding: 1rem;
      }
      .summary-card h6 {
        font-size: 0.8rem;
      }
      .summary-card p {
        font-size: 1.2rem;
      }
    }
    @media (max-width: 480px) {
      /* S-12.3: Main container and navbar brand for mobile */
      .main-container {
        margin: 0.5rem;
        padding: 1rem;
      }
      .navbar-brand {
        font-size: 1.5rem;
      }
    }

    /* S-13: Loading Overlay */
    .loading-overlay {
      /* S-13.1: Loading overlay styles for async loading states */
      background: rgba(255, 255, 255, 0.9);
    }
    .spinner-border {
      /* S-13.2: Spinner color */
      color: var(--accent-color);
    }

    /* S-14: Page Title Section */
    .page-title-section {
      /* S-14.1: Title section with hover & animation */
      text-align: center;
      margin-bottom: 2.5rem;
      padding: 1rem 0;
      position: relative;
      opacity: 0;
      animation: fadeIn 0.8s ease-out forwards;
      animation-delay: 0.1s;
    }
    .page-title-section h1 {
      /* S-14.2: Animate title hover underline with gradient */
      font-family: 'Poppins', sans-serif;
      font-size: 2rem;
      color: var(--title-color);
      font-weight: 600;
      margin: 0;
      padding: 0;
      display: inline-block;
      cursor: pointer;
      transition: color 0.2s ease;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      position: relative;
      z-index: 1;
      padding: 10px;  /* Increase clickable area */
    }
    .page-title-section h1:hover {
      /* S-14.3: Title hover color */
      color: var(--accent-color);
    }
    .page-title-section h1::after {
      /* S-14.4: Underline effect on hover (using pseudo-element) */
      content: '';
      position: absolute;
      bottom: -8px;
      left: 50%;
      transform: translateX(-50%);
      width: 60%;
      height: 3px;
      background: linear-gradient(to right, transparent, var(--accent-color), transparent);
    }

    /* S-15: Page Loader */
    .page-loader {
      /* S-15.1: Loading overlay for smooth page transitions */
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--gradient-start);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      animation: fadeOut 0.5s ease-out forwards;
      animation-delay: 0.2s;
    }
    @keyframes fadeOut {
      /* S-15.2: Fade out animation for loader */
      from { opacity: 1; }
      to { opacity: 0; visibility: hidden; }
    }

    /* S-16: Bootstrap Navbar Fixes */
    .navbar .container-fluid {
      /* S-16.1: Additional: Fix for Bootstrap Navbar collapse on small screens */
      justify-content: space-between !important;
    }
    .navbar-collapse {
      /* S-16.2: Prevent navbar collapse from growing */
      flex-grow: 0;
    }

    /* S-17: Animations */
    @keyframes fadeInUp {
      /* S-17.1: Fade in up animation */
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    @keyframes fadeIn {
      /* S-17.2: Fade in animation */
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* S-18: Mobile Navbar Styles */
    .navbar-toggler {
      /* S-18.1: Additional navbar styles for mobile */
      border: none;
      padding: 0.25rem;
    }

    .navbar-toggler:focus {
      /* S-18.2: Remove outline on focus */
      box-shadow: none;
      outline: none;
    }

    .navbar-toggler-icon {
      /* S-18.3: Toggler icon size */
      width: 1.5em;
      height: 1.5em;
    }

    .nav-link {
      /* S-18.4: Nav link styling for mobile */
      color: var(--title-color) !important;
      font-weight: 500;
      transition: all 0.3s ease;
      padding: 0.5rem 1rem;
    }

    .nav-link:hover {
      /* S-18.5: Nav link hover effect for mobile */
      color: var(--accent-color) !important;
      transform: translateX(5px);
    }

    @media (max-width: 991px) {
      /* S-18.6: Navbar collapse and nav item adjustments for mobile */
      .navbar-collapse {
        background: white;
        padding: 1rem;
        border-radius: 0.5rem;
        box-shadow: 0 4px 12px var(--shadow-color);
        position: absolute;
        top: 100%;
        right: 1rem;
        left: 1rem;
        z-index: 1040;  /* Higher than navbar */
        max-height: calc(100vh - 70px); /* Prevent overflow */
        overflow-y: auto;
      }
      
      .nav-item {
        margin: 0.5rem 0;
      }
    }

    .counter-animation {
      /* S-19: Counter animation utility */
      transition: all 0.2s ease;
    }

    .clickable {
      /* S-20: Clickable utility class */
      cursor: pointer;
      touch-action: manipulation; /* Optimize for touch */
      -webkit-tap-highlight-color: transparent;
    }

    .navbar-toggler {
      /* S-21: Navbar toggler button styling */
      width: 44px;
      height: 44px;
      position: relative;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background-color: transparent;
      padding: 0;
      margin-left: auto;
    }

    .navbar-toggler:focus {
      /* S-21.1: Toggler focus effect */
      outline: none;
      box-shadow: 0 0 0 3px rgba(179, 153, 204, 0.25);
    }

    @media (max-width: 991px) {
      /* S-22: Navbar collapse for mobile fixed position */
      .navbar-collapse {
        position: fixed;
        top: 70px;  /* Adjust based on your navbar height */
        left: 0;
        right: 0;
        background: white;
        padding: 1rem;
        border-radius: 0 0 1rem 1rem;
        box-shadow: 0 4px 12px var(--shadow-color);
        max-height: calc(100vh - 70px);
        overflow-y: auto;
        transition: all 0.3s ease;
        transform: translateY(-100%);
        opacity: 0;
        visibility: hidden;
      }

      .navbar-collapse.show {
        transform: translateY(0);
        opacity: 1;
        visibility: visible;
      }
      
      .nav-item {
        margin: 0.5rem 0;
        width: 100%;
      }

      .nav-link {
        display: block;
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
      }

      .nav-link:active {
        background-color: var(--primary-color);
      }
    }

    .page-title-section a {
      /* S-23: Title link styling */
      text-decoration: none;
      display: inline-block;
      width: auto;
    }
  </style>
</head>

<!-- H-4: Body Content -->
<!-- H-4.1: Main body structure for loader, navbar, main content, footer -->
<body>

  <!-- H-5: Page Loader -->
  <!-- H-5.1: Loading overlay shown at page load for smooth transition -->
  <div class="page-loader">
    <div class="spinner-border" style="color: var(--accent-color); width: 3rem; height: 3rem;"></div>
  </div>

  <!-- H-6: Navbar -->
  <!-- H-6.1: Main navigation bar with branding and links -->
  <nav class="navbar navbar-expand-lg">
    <div class="container-fluid">
      <a class="navbar-brand" href="/">
        <i class="fas fa-gem"></i>
        <strong>Stationer Tracker</strong>
      </a>
      <!-- H-6.2: Navbar toggler for mobile -->
      <button class="navbar-toggler" 
              type="button" 
              data-bs-toggle="collapse" 
              data-bs-target="#navbarNav" 
              aria-controls="navbarNav" 
              aria-expanded="false" 
              aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <!-- H-6.3: Navbar links -->
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <!-- H-6.3.1: Navigation links for different sections -->
          <li class="nav-item">
            <a class="nav-link" href="/projects">Design Projects</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/inquiry">Sales & Inquiry Tracker</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/time">Time & Hours</a>
          </li>
          <li class="nav-item"><a class="nav-link" href="/costs">Expenses & Profit</a></li>
          <li class="nav-item"><a class="nav-link" href="/issues">Workflow & Challenges</a></li>
          <li class="nav-item">
            <a class="nav-link" href="/client-experiences">Clients & Feedback</a>
          </li>
          <li class="nav-item"><a class="nav-link" href="/posts">Content & Ideas</a></li>
          <li class="nav-item"><a class="nav-link" href="/tasks">Tasks & Routine</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- H-7: Main Content Area -->
  <main class="main-container" id="scrollContainer">
    <!-- H-7.1: Page Title Section -->
    <div class="page-title-section">
      <a href="/projects" class="title-link">
        <h1>Projects Management</h1>
      </a>
    </div>

    <!-- Controls: Add new project & show limit -->
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-3">
      <button class="btn btn-primary btn-sm" id="addProjectBtn">+ Add Project</button>
      <!-- Add search box here -->
      <div class="input-group input-group-sm flex-grow-1" style="max-width: 300px;">
        <input type="text" id="searchBox" class="form-control" placeholder="Search project or client..." 
               onkeyup="if(event.key === 'Enter') searchProjects()">
        <button class="btn btn-outline-secondary" onclick="searchProjects()">
          <i class="fas fa-search"></i>
        </button>
      </div>
      <div class="d-flex align-items-center">
        <label class="me-2 mb-0">Show</label>
        <select id="limitSelect" class="form-select form-select-sm w-auto">
          <option value="5">5</option>
          <option value="10" selected>10</option>
          <option value="25">25</option>
          <option value="50">50</option>
        </select>
        <span class="ms-2">entries</span>
      </div>
    </div>

    <!-- FORM: for adding/editing projects (hidden by default) -->
    <section id="projectFormSection" style="display:none;">
      <form id="projectForm" class="p-3 border rounded bg-white mb-4">
        <!-- Hidden inputs for IDs -->
        <input type="hidden" id="project_id" />
        <input type="hidden" id="client_id" />

        <!-- Input fields: organized in rows and columns -->
        <div class="row mb-2">
          <div class="col-md-6">
            <label>Client Name</label>
            <input type="text" class="form-control" id="client_name" required />
          </div>
          <div class="col-md-6">
            <label>Client Email</label>
            <input class="form-control" id="client_email" type="email" />
          </div>
        </div>

        <div class="row mb-2">
          <div class="col-md-6">
            <label>Client Phone</label>
            <input class="form-control" id="client_phone" />
          </div>
          <div class="col-md-6">
            <label>Project Reference</label>
            <input class="form-control" id="project_reference" />
          </div>
        </div>

        <div class="row mb-2">
          <div class="col-md-6">
            <label>Inquiry Date</label>
            <input class="form-control" id="inquiry_date" type="date" />
          </div>
          <div class="col-md-6">
            <label>Source</label>
            <select class="form-select" id="source"></select>
          </div>
        </div>

        <div class="row mb-2">
          <div class="col-md-6">
            <label>Project Type</label>
            <select class="form-select" id="project_type"></select>
          </div>
          <div class="col-md-6">
            <label>Conversion Status</label>
            <select class="form-select" id="conversion_status"></select>
          </div>
        </div>

        <!-- Lost Reason field (only shown when status is LST) -->
        <div class="row mb-2" id="lostReasonRow" style="display:none;">
          <div class="col-md-6">
            <label>Lost Reason</label>
            <select class="form-select" id="lost_reason"></select>
          </div>
          <div class="col-md-6">
            <!-- Keep this empty for layout balance -->
          </div>
        </div>

        <div class="row mb-2">
          <div class="col-md-6">
            <label>Quoted Amount</label>
            <input type="number" class="form-control" id="quoted_amount" />
          </div>
          <div class="col-md-6">
            <label>Final Amount</label>
            <input type="number" class="form-control" id="final_amount" />
          </div>
        </div>

        <div class="row mb-2">
          <div class="col-md-6">
            <label>Contract Signed Date</label>
            <input type="date" class="form-control" id="contract_signed_date" />
          </div>
          <div class="col-md-6">
            <label>Project Deadline</label>
            <input type="date" class="form-control" id="project_deadline" />
          </div>
        </div>

        <!-- Form buttons: Save & Close -->
        <div class="d-flex gap-2 mt-3">
          <button class="btn btn-success btn-sm" type="submit">Save</button>
          <button class="btn btn-outline-danger btn-sm" type="button" onclick="closeForm()">Close</button>
        </div>
      </form>
    </section>

    <!-- PROJECTS TABLE -->
    <section class="table-responsive position-relative mb-4">
      <!-- Loading overlay (hidden initially) -->
      <div id="loading" class="loading-overlay" style="display:none;">
        <div class="spinner-border text-danger"></div>
      </div>
      <!-- Projects list table -->
      <table class="table table-bordered table-striped mb-0">
        <thead class="table-light">
          <tr>
            <th>#</th>
            <th>Client</th>
            <th>Reference</th>
            <th>Inquiry Date</th>
            <th>Source</th>
            <th>Conversion</th>
            <th>Quoted</th>
            <th>Final</th>
            <th>Expand</th> <!-- Changed from "Edit" to "Expand" -->
          </tr>
        </thead>
        <tbody id="projectTableBody"></tbody>
      </table>
    </section>

    <!-- Pagination Controls -->
    <nav class="pagination-controls mb-4 justify-content-center d-flex gap-2">
      <button id="prevBtn" class="btn btn-sm btn-outline-secondary" onclick="changePage(-1)">Prev</button>
      <span id="pageIndicator">Page 1</span>
      <button id="nextBtn" class="btn btn-sm btn-outline-secondary" onclick="changePage(1)">Next</button>
    </nav>
  </main>

  <!-- H-8: Footer -->
  <footer class="footer">
    © <strong style="color: var(--title-color);">Stationer Success Tracker</strong>. Built with ❤️ to help creative businesses thrive.
  </footer>

  <!-- H-9: Scripts and JS Logic -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // PT-1: API Endpoints Configuration
    const API_ENDPOINTS = {
      PROJECTS: '/api/projects',           // List of projects
      PROJECT: '/api/project',             // Single project get/update/delete
      LOV: '/api/lov/'                     // List of values (for dropdowns)
    };

    // PT-2: State Variables
    let currentPage = 1;
    let limit = 10;
    let lastSearchQuery = ""; // Add search state variable

    // PT-3: Initialization
    window.onload = () => {
      document.querySelector('.page-loader').style.display = 'none';
      document.getElementById("inquiry_date").value = getTodayDate();
      loadLOV("CONVERSION_STATUS", "conversion_status").then(() => {
        document.getElementById("conversion_status").value = "PENDING";
      });
      loadLOV("LEAD_SOURCE", "source");
      loadLOV("PROJECT_TYPE", "project_type");
      loadLostReasons();
      loadProjects();
      
      // Add event listener for conversion status changes
      document.getElementById("conversion_status").addEventListener("change", handleConversionStatusChange);

      // Add event listener for search box input
      document.getElementById("searchBox").addEventListener("input", function() {
        lastSearchQuery = this.value.trim();
      });
    };

    // PT-4: Event Listeners
    document.getElementById("limitSelect").addEventListener("change", () => {
      limit = parseInt(document.getElementById("limitSelect").value);
      currentPage = 1;
      loadProjects();
    });

    document.getElementById("addProjectBtn").addEventListener("click", () => {
      resetForm();
    });

    // Add search function to trigger search with pagination reset
    function searchProjects() {
      currentPage = 1;
      loadProjects();
    }

    // PT-5: Functions
    
    // PT-5.1: Handle conversion status change
    function handleConversionStatusChange() {
      const status = document.getElementById("conversion_status").value;
      toggleLostReasonField(status);
      
      // If switching to lost status, ensure the lost reason field is loaded
      if (status === 'LST') {
        loadLostReasons();
      }
    }
    
    // PT-5.2: Load Lost Reasons dropdown
    async function loadLostReasons() {
      try {
        const res = await fetch(`${API_ENDPOINTS.LOV}LOST_REASON`);
        const data = await res.json();
        const select = document.getElementById("lost_reason");
        select.innerHTML = `<option value="">-- Select --</option>`;
        data.forEach(item => {
          select.innerHTML += `<option value="${item.code_value}">${item.code_description}</option>`;
        });
      } catch (err) {
        showToast("Failed to load lost reason options", "warning");
      }
    }

    async function loadProjects() {
      document.getElementById("loading").style.display = "flex";
      try {
        const res = await fetch(`${API_ENDPOINTS.PROJECTS}?page=${currentPage}&limit=${limit}&search=${encodeURIComponent(lastSearchQuery)}`);
        const data = await res.json();
        const tbody = document.getElementById("projectTableBody");
        tbody.innerHTML = "";

        if (!data.length) {
          document.getElementById("pageIndicator").innerText = "No records";
          document.getElementById("prevBtn").style.display = "none";
          document.getElementById("nextBtn").style.display = "none";
          return;
        }

        // Update pagination info
        document.getElementById("pageIndicator").innerText = `Page ${currentPage}`;
        // Show/hide pagination buttons
        document.getElementById("prevBtn").style.display = currentPage === 1 ? "none" : "inline-block";
        document.getElementById("nextBtn").style.display = data.length < limit ? "none" : "inline-block";

        // Populate table rows
        data.forEach((row, idx) => {
          const sno = (currentPage - 1) * limit + idx + 1;
          const projectId = row.project_id;

          tbody.innerHTML += `
            <tr>
              <td>${sno}</td>
              <td>${row.client_name}</td>
              <td>${row.project_reference}</td>
              <td>${row.inquiry_date || ""}</td>
              <td>${row.source_desc || ""}</td>
              <td>${row.conversion_status_desc || ""}</td>
              <td>${row.quoted_amount || ""}</td>
              <td>${row.final_amount || ""}</td>
              <td>
                <button class="btn btn-sm btn-link p-0" onclick="toggleProjectDetails(this, ${projectId})">
                  <i class="fas fa-chevron-down"></i>
                </button>
              </td>
            </tr>
            <!-- Hidden row for project details -->
            <tr class="details-row" style="display: none;" data-project="${projectId}">
              <td colspan="9">
                <div class="px-3 py-2">
                  <div class="d-flex justify-content-end mb-2">
                    <button class="btn btn-sm btn-primary me-2" onclick="editProject(${projectId})">
                      <i class="fas fa-edit"></i> Edit Project
                    </button>
                  </div>
                  <table class="table table-sm mb-0">
                    <tbody id="details-${projectId}">
                      <tr><td colspan="2">Loading project details...</td></tr>
                    </tbody>
                  </table>
                </div>
              </td>
            </tr>
          `;
        });
      } catch (error) {
        showToast("Unable to load data. Please try again.", "danger");
      } finally {
        document.getElementById("loading").style.display = "none";
      }
    }

    function changePage(dir) {
      currentPage += dir;
      loadProjects();
    }

    async function editProject(projectId) {
      try {
        const detailsBody = document.getElementById(`details-${projectId}`);
        if (!detailsBody) return;
        
        const res = await fetch(`${API_ENDPOINTS.PROJECT}/${projectId}`);
        const data = await res.json();
        if (!data || Object.keys(data).length === 0) return;
        
        // Create inline edit form
        let editFormHTML = `
          <tr>
            <td colspan="2">
              <form id="inline-project-form-${projectId}" class="border rounded p-3 bg-light">
                <input type="hidden" id="inline_project_id" value="${data.project_id || ''}">
                <input type="hidden" id="inline_client_id" value="${data.client_id || ''}">
                
                <!-- Client Information -->
                <div class="mb-3">
                  <h6 class="text-muted border-bottom pb-2">Client Information</h6>
                  <div class="row g-2 mb-2">
                    <div class="col-md-6">
                      <label class="form-label">Client Name</label>
                      <input type="text" class="form-control form-control-sm" id="inline_client_name" value="${data.client_name || ''}" required>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Client Email</label>
                      <input type="email" class="form-control form-control-sm" id="inline_client_email" value="${data.client_email || ''}">
                    </div>
                  </div>
                  <div class="row g-2">
                    <div class="col-md-6">
                      <label class="form-label">Client Phone</label>
                      <input type="text" class="form-control form-control-sm" id="inline_client_phone" value="${data.client_phone || ''}">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Project Reference</label>
                      <input type="text" class="form-control form-control-sm" id="inline_project_reference" value="${data.project_reference || ''}">
                    </div>
                  </div>
                </div>
                
                <!-- Project Details -->
                <div class="mb-3">
                  <h6 class="text-muted border-bottom pb-2">Project Details</h6>
                  <div class="row g-2 mb-2">
                    <div class="col-md-6">
                      <label class="form-label">Project Type</label>
                      <select class="form-select form-select-sm" id="inline_project_type"></select>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Source</label>
                      <select class="form-select form-select-sm" id="inline_source"></select>
                    </div>
                  </div>
                  <div class="row g-2">
                    <div class="col-md-6">
                      <label class="form-label">Conversion Status</label>
                      <select class="form-select form-select-sm" id="inline_conversion_status" onchange="inlineToggleLostReason()"></select>
                    </div>
                    <div class="col-md-6" id="inline_lost_reason_container" style="display: none;">
                      <label class="form-label">Lost Reason</label>
                      <select class="form-select form-select-sm" id="inline_lost_reason"></select>
                    </div>
                  </div>
                </div>
                
                <!-- Financial Information -->
                <div class="mb-3">
                  <h6 class="text-muted border-bottom pb-2">Financial Information</h6>
                  <div class="row g-2">
                    <div class="col-md-6">
                      <label class="form-label">Quoted Amount</label>
                      <input type="number" class="form-control form-control-sm" id="inline_quoted_amount" value="${data.quoted_amount || ''}">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Final Amount</label>
                      <input type="number" class="form-control form-control-sm" id="inline_final_amount" value="${data.final_amount || ''}">
                    </div>
                  </div>
                </div>
                
                <!-- Important Dates -->
                <div class="mb-3">
                  <h6 class="text-muted border-bottom pb-2">Important Dates</h6>
                  <div class="row g-2">
                    <div class="col-md-4">
                      <label class="form-label">Inquiry Date</label>
                      <input type="date" class="form-control form-control-sm" id="inline_inquiry_date" value="${data.inquiry_date || getTodayDate()}">
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Contract Signed</label>
                      <input type="date" class="form-control form-control-sm" id="inline_contract_signed_date" value="${data.contract_signed_date || ''}">
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Deadline</label>
                      <input type="date" class="form-control form-control-sm" id="inline_project_deadline" value="${data.project_deadline || ''}">
                    </div>
                  </div>
                </div>
                
                <!-- Form Actions -->
                <div class="d-flex justify-content-end mt-3 gap-2">
                  <button type="button" class="btn btn-sm btn-outline-secondary" onclick="cancelInlineProjectEdit(${projectId})">Cancel</button>
                  <button type="button" class="btn btn-sm btn-success" onclick="saveInlineProjectEdit(${projectId})">Save Changes</button>
                </div>
              </form>
            </td>
          </tr>
        `;
        
        // Replace the details content with the edit form
        detailsBody.innerHTML = editFormHTML;
        
        // Load dropdown options
        await Promise.all([
          loadInlineLOV("CONVERSION_STATUS", "inline_conversion_status"),
          loadInlineLOV("LEAD_SOURCE", "inline_source"),
          loadInlineLOV("PROJECT_TYPE", "inline_project_type"),
          loadInlineLOV("LOST_REASON", "inline_lost_reason")
        ]);
        
        // Set selected values for dropdowns
        document.getElementById("inline_conversion_status").value = data.conversion_status || "";
        document.getElementById("inline_source").value = data.source || "";
        document.getElementById("inline_project_type").value = data.project_type || "";
        
        // Handle lost reason visibility
        if (data.conversion_status === 'LST') {
          document.getElementById("inline_lost_reason_container").style.display = "block";
          document.getElementById("inline_lost_reason").value = data.lost_reason || "";
        }
        
        // Add phone number validation
        document.getElementById("inline_client_phone").addEventListener("input", function() {
          this.value = this.value.replace(/\D/g, '');
          if (this.value.length > 10) this.value = this.value.slice(0, 10);
        });
        
      } catch (err) {
        showToast("Could not load project details for editing.", "danger");
        console.error("editProject error:", err);
      }
    }

    // Add function to load dropdowns for inline editing
    async function loadInlineLOV(refName, selectId) {
      try {
        const res = await fetch(`${API_ENDPOINTS.LOV}${refName}`);
        const data = await res.json();
        const select = document.getElementById(selectId);
        select.innerHTML = `<option value="">-- Select --</option>`;
        data.forEach(item => {
          select.innerHTML += `<option value="${item.code_value}">${item.code_description}</option>`;
        });
      } catch (err) {
        showToast(`Failed to load options for ${refName}`, "warning");
        console.error("loadInlineLOV error:", err);
      }
    }

    // Toggle lost reason field in inline form
    function inlineToggleLostReason() {
      const status = document.getElementById("inline_conversion_status").value;
      const container = document.getElementById("inline_lost_reason_container");
      
      if (status === 'LST') {
        container.style.display = "block";
      } else {
        container.style.display = "none";
      }
    }

    // Cancel inline edit and return to details view
    function cancelInlineProjectEdit(projectId) {
      // Reload the original project details
      const button = document.querySelector(`button[onclick="toggleProjectDetails(this, ${projectId})"]`);
      if (button) {
        // Close and reopen to refresh the details
        if (button.innerHTML.includes('chevron-up')) {
          toggleProjectDetails(button, projectId); // Close
          toggleProjectDetails(button, projectId); // Reopen
        }
      }
    }

    // Save inline project edit
    async function saveInlineProjectEdit(projectId) {
      try {
        // Collect form data
        const payload = {
          project_id: document.getElementById("inline_project_id").value,
          client_id: document.getElementById("inline_client_id").value,
          client_name: document.getElementById("inline_client_name").value.trim(),
          client_email: document.getElementById("inline_client_email").value.trim(),
          client_phone: document.getElementById("inline_client_phone").value.trim(),
          project_reference: document.getElementById("inline_project_reference").value.trim(),
          project_type: document.getElementById("inline_project_type").value,
          source: document.getElementById("inline_source").value,
          conversion_status: document.getElementById("inline_conversion_status").value,
          quoted_amount: document.getElementById("inline_quoted_amount").value,
          final_amount: document.getElementById("inline_final_amount").value,
          inquiry_date: document.getElementById("inline_inquiry_date").value,
          contract_signed_date: document.getElementById("inline_contract_signed_date").value,
          project_deadline: document.getElementById("inline_project_deadline").value
        };
        
        // Add lost reason if applicable
        if (payload.conversion_status === 'LST') {
          payload.lost_reason = document.getElementById("inline_lost_reason").value;
        }
        
        // Basic validation
        if (!payload.client_name) {
          showToast("Client Name is required", "danger");
          return;
        }
        if (payload.client_phone && payload.client_phone.length !== 10) {
          showToast("Client Phone must be exactly 10 digits", "danger");
          return;
        }
        
        // Send data to API
        const res = await fetch(API_ENDPOINTS.PROJECT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        
        const result = await res.json();
        
        if (res.ok && (result.success || result.status === "success")) {
          showToast(result.message || "Project updated successfully", "success");
          
          // Refresh the details view
          cancelInlineProjectEdit(projectId);
          
          // Also refresh the project list to show updated data
          loadProjects();
        } else {
          showToast(result.message || "Failed to update project", "danger");
        }
      } catch (err) {
        showToast("Server error. Please try again later.", "danger");
        console.error("saveInlineProjectEdit error:", err);
      }
    }

    function toggleLostReasonField(status) {
      const lostReasonRow = document.getElementById("lostReasonRow");
      if (status === 'LST') {
        lostReasonRow.style.display = "flex";
      } else {
        lostReasonRow.style.display = "none";
      }
    }

    function getTodayDate() {
      const today = new Date();
      return `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
    }

    async function loadLOV(refName, selectId) {
      try {
        const res = await fetch(`${API_ENDPOINTS.LOV}${refName}`);
        const data = await res.json();
        const select = document.getElementById(selectId);
        select.innerHTML = `<option value="">-- Select --</option>`;
        data.forEach(item => {
          select.innerHTML += `<option value="${item.code_value}">${item.code_description}</option>`;
        });
      } catch (err) {
        showToast(`Failed to load options for ${refName}`, "warning");
      }
    }

    async function resetForm() {
      document.getElementById("projectForm").reset();
      document.getElementById("project_id").value = "";
      document.getElementById("client_id").value = "";
      document.getElementById("inquiry_date").value = getTodayDate();
      await loadLOV("CONVERSION_STATUS", "conversion_status");
      document.getElementById("conversion_status").value = "PND";
      document.getElementById("project_reference").disabled = true;
      document.getElementById("projectFormSection").style.display = "block";
      
      // Hide lost reason field by default
      toggleLostReasonField("");
      
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Input validation for phone number
    document.getElementById("client_phone").addEventListener("input", () => {
      const input = document.getElementById("client_phone");
      input.value = input.value.replace(/\D/g, '');
      if (input.value.length > 10) input.value = input.value.slice(0, 10);
    });

    // Submit handler for project form
    document.getElementById("projectForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const payload = {};
      [...document.querySelectorAll("#projectForm input, #projectForm select")].forEach(el => {
        if (el.id) payload[el.id] = el.value.trim();
      });

      // Basic validation
      if (!payload.client_name) {
        showToast("Client Name is required", "danger");
        return;
      }
      if (payload.client_phone && payload.client_phone.length !== 10) {
        showToast("Client Phone must be exactly 10 digits", "danger");
        return;
      }
      
      // Ensure we only include lost_reason if conversion_status is LST
      if (payload.conversion_status !== 'LST') {
        delete payload.lost_reason;
      }

      // Send data to API
      try {
        const res = await fetch(API_ENDPOINTS.PROJECT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        const result = await res.json();
        if (res.ok && (result.success || result.status === "success")) {
          showToast(result.message || "Saved", "success");
          closeForm();
          loadProjects();
          window.scrollTo({ top: 0, behavior: 'smooth' });
        } else {
          showToast(result.message || "Something went wrong.", "danger");
        }
      } catch (err) {
        showToast("Server error. Please try again later.", "danger");
      }
    });

    // Close form
    function closeForm() {
      document.getElementById("projectForm").reset();
      document.getElementById("projectFormSection").style.display = "none";
    }

    // Show toast notifications
    function showToast(message, type = "info") {
      const toast = document.createElement("div");
      toast.className = `alert alert-${type}`;
      toast.innerText = message;
      toast.style.marginBottom = "10px";
      toast.style.minWidth = "250px";
      toast.style.boxShadow = "0 0 10px rgba(0,0,0,0.2)";
      document.getElementById("toastBox").appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    // Initialize mobile navigation and other UI elements
    document.addEventListener('DOMContentLoaded', function() {
      // Mobile nav toggler and close logic
      const navbarToggler = document.querySelector('.navbar-toggler');
      const navbarCollapse = document.querySelector('.navbar-collapse');
      
      if (navbarToggler && navbarCollapse) {
        // Prevent double-firing of click events
        navbarToggler.addEventListener('click', function(e) {
          e.stopPropagation();
          navbarCollapse.classList.toggle('show');
          this.setAttribute('aria-expanded', 
            navbarCollapse.classList.contains('show')
          );
        });

        // Close menu when clicking outside
        document.addEventListener('click', function(e) {
          if (!navbarCollapse.contains(e.target) && 
              !navbarToggler.contains(e.target)) {
            navbarCollapse.classList.remove('show');
            navbarToggler.setAttribute('aria-expanded', 'false');
          }
        });
      }

      // Enable touch events on clickable elements
      document.querySelectorAll('.clickable, .title-link').forEach(element => {
        element.addEventListener('touchend', function(e) {
          e.preventDefault();
          const href = this.getAttribute('href');
          if (href) window.location.href = href;
        });
      });
    });

    // Add the toggleProjectDetails function
    async function toggleProjectDetails(button, projectId) {
      const detailRow = document.querySelector(`tr.details-row[data-project="${projectId}"]`);
      const detailsBody = document.getElementById(`details-${projectId}`);

      if (detailRow.style.display === "none") {
        // Expand row
        detailRow.style.display = "table-row";
        button.innerHTML = '<i class="fas fa-chevron-up"></i>';

        try {
          // Fetch project details
          const res = await fetch(`${API_ENDPOINTS.PROJECT}/${projectId}`);
          const data = await res.json();
          
          if (!data || Object.keys(data).length === 0) {
            detailsBody.innerHTML = `<tr><td colspan="2">No project details found.</td></tr>`;
            return;
          }
          
          // Format the details into a readable table
          let detailsHTML = '';
          
          // Client details section
          detailsHTML += `
            <tr><th colspan="2" class="bg-light">Client Information</th></tr>
            <tr>
              <td width="30%"><strong>Client Name:</strong></td>
              <td>${data.client_name || '-'}</td>
            </tr>
            <tr>
              <td><strong>Email:</strong></td>
              <td>${data.client_email || '-'}</td>
            </tr>
            <tr>
              <td><strong>Phone:</strong></td>
              <td>${data.client_phone || '-'}</td>
            </tr>
          `;
          
          // Project details section
          detailsHTML += `
            <tr><th colspan="2" class="bg-light mt-2">Project Details</th></tr>
            <tr>
              <td><strong>Reference:</strong></td>
              <td>${data.project_reference || '-'}</td>
            </tr>
            <tr>
              <td><strong>Type:</strong></td>
              <td>${data.project_type_desc || '-'}</td>
            </tr>
            <tr>
              <td><strong>Source:</strong></td>
              <td>${data.source_desc || '-'}</td>
            </tr>
            <tr>
              <td><strong>Status:</strong></td>
              <td>${data.conversion_status_desc || '-'}</td>
            </tr>
          `;
          
          // Show lost reason only if status is lost
          if (data.conversion_status === 'LST') {
            detailsHTML += `
              <tr>
                <td><strong>Lost Reason:</strong></td>
                <td>${data.lost_reason_desc || '-'}</td>
              </tr>
            `;
          }
          
          // Financial information
          detailsHTML += `
            <tr><th colspan="2" class="bg-light">Financial Information</th></tr>
            <tr>
              <td><strong>Quoted Amount:</strong></td>
              <td>${data.quoted_amount ? `$${parseFloat(data.quoted_amount).toFixed(2)}` : '-'}</td>
            </tr>
            <tr>
              <td><strong>Final Amount:</strong></td>
              <td>${data.final_amount ? `$${parseFloat(data.final_amount).toFixed(2)}` : '-'}</td>
            </tr>
          `;
          
          // Dates
          detailsHTML += `
            <tr><th colspan="2" class="bg-light">Important Dates</th></tr>
            <tr>
              <td><strong>Inquiry Date:</strong></td>
              <td>${data.inquiry_date || '-'}</td>
            </tr>
            <tr>
              <td><strong>Contract Signed:</strong></td>
              <td>${data.contract_signed_date || '-'}</td>
            </tr>
            <tr>
              <td><strong>Deadline:</strong></td>
              <td>${data.project_deadline || '-'}</td>
            </tr>
          `;
          
          detailsBody.innerHTML = detailsHTML;
          
        } catch (err) {
          console.error("Error loading project details:", err);
          detailsBody.innerHTML = `<tr><td colspan="2">Error loading project details</td></tr>`;
        }
      } else {
        // Collapse row
        detailRow.style.display = "none";
        button.innerHTML = '<i class="fas fa-chevron-down"></i>';
      }
    }
  </script>

  <!-- H-10: Toast container for user messages -->
  <div id="toastBox" style="position: fixed; top: 1rem; right: 1rem; z-index: 9999;"></div>

  <!-- H-11: Delete Confirmation Modal -->
  <div class="modal fade" id="deleteConfirmationModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Confirm Deletion</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          Are you sure you want to delete this expense?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger btn-sm" id="confirmDeleteBtn">Delete</button>
        </div>
      </div>
    </div>
  </div>

</body>
</html>